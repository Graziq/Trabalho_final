name: Deploy Prefect Flow

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest # Melhor usar Linux para Docker, a menos que haja uma razÃ£o forte para Windows
    # O uso de `windows-latest` no GH Actions para construir e registrar deployments Docker
    # Ã© um pouco mais complexo se vocÃª for construir imagens Docker no Windows runner.
    # Mudei para Ubuntu, que Ã© mais comum para Docker builds.

    steps:
      - name: ğŸ” Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ Instalar Python 3.12.5
        uses: actions/setup-python@v4
        with:
          python-version: "3.12.5"

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          # Assegure que prefect esteja instalado para o `prefect deploy`
          pip install "prefect==2.16.4"

      - name: ğŸ”— Configurar conexÃ£o com Prefect Server remoto
        run: |
          prefect config set PREFECT_API_URL="${{ secrets.PREFECT_SERVER_URL }}/api"
          # prefect config set PREFECT_API_KEY="${{ secrets.PREFECT_API_KEY }}" # Se vocÃª tiver uma API Key
          prefect profile ls
        env:
          # Para garantir que a API key seja usada se configurada
          PREFECT_API_KEY: ${{ secrets.PREFECT_API_KEY }}

      # NOVO: Construir a imagem Docker ANTES de registrar o deployment
      # A imagem serÃ¡ usada pelo serviÃ§o Dash e potencialmente pelo Prefect Worker/Agent
      - name: ğŸ³ Build Docker image
        run: |
          docker build -t meu-projeto-power-system . # O nome da sua imagem
          docker images # Para verificar

      # NOVO: Iniciar o Docker Compose para o servidor Prefect e agente
      - name: â¬†ï¸ Start Docker Compose services
        run: |
          docker-compose -f infra/docker-compose.yml up -d --build # --build para reconstruir o Dash-app
        # Para garantir que o docker-compose tenha tempo de iniciar
        sleep 10
        working-directory: .

      - name: ğŸš€ Deploy do Flow
        # prefect deploy usarÃ¡ o prefect.yaml na raiz do repositÃ³rio
        run: |
          prefect deploy
        working-directory: . # Certifique-se de que estÃ¡ na raiz do repositÃ³rio

        

# name: Deploy Prefect Flow

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: windows-latest # Alterado para Windows

#     steps:
#       - name: ğŸ” Checkout do cÃ³digo
#         uses: actions/checkout@v3

#       - name: ğŸ Instalar Python 3.12.5
#         uses: actions/setup-python@v4
#         with:
#           python-version: "3.12.5"

#       - name: ğŸ“¦ Instalar dependÃªncias
#         run: |
#           python -m pip install -U pip
#           python -m pip install -r requirements.txt
#           python -m pip install "prefect==2.16.4" pandapower networkx pandas numpy
#           # Configura PYTHONPATH para Windows (PowerShell)
#           $env:PYTHONPATH="$env:PYTHONPATH;$(Get-Location)\src"
        
#         shell: powershell

#       - name: ğŸ”— Configurar conexÃ£o com Prefect Server remoto
#         run: |
#           # Define a PREFECT_API_URL usando a sintaxe do PowerShell
#           prefect config set PREFECT_API_URL="${{ secrets.PREFECT_SERVER_URL }}/api"
#           prefect profile ls

#         shell: powershell # Garante PowerShell para este passo tambÃ©m

#       - name: ğŸš€ Deploy do Flow
#         run: |
#           prefect deploy
#         shell: powershell
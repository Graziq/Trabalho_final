name: Deploy Prefect Flows

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: üîÅ Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: üêç Instalar Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install -U pip
          python -m pip install -r requirements.txt
          python -m pip install "prefect==2.16.4"
          
          # Configura PYTHONPATH para Windows (PowerShell)
          # Isso √© crucial para que o Prefect encontre os m√≥dulos dentro de 'src'
          $env:PYTHONPATH="$env:PYTHONPATH;$(Get-Location)\src"
        shell: powershell

      - name: üîó Configurar conex√£o com Prefect Server remoto
        run: |
          # Define a URL da API do seu Prefect Server usando um secret do GitHub
          prefect config set PREFECT_API_URL="${{ secrets.PREFECT_SERVER_URL }}/api"
          Write-Host "URL da API do Prefect configurada."
          prefect profile ls # Opcional: Para verificar o perfil ativo
        shell: powershell

      - name: üöÄ Deploy do Flow com retry
        run: |
          for i in {1..5}; do
            prefect deploy -n simulacao-e-visualizacao-orchestrator-deployment && break || sleep 5
          done
        shell: powershell
name: Check Prefect Flow Quality

on:
  push: # Este workflow ser√° acionado quando houver um push
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_and_test:
    runs-on: windows-latest # O job ser√° executado em um runner Windows

    steps: # Sequ√™ncia de passos
      - name: üîÅ Checkout do c√≥digo # Passo para baixar seu c√≥digo
        uses: actions/checkout@v3

      - name: üêç Instalar Python 3.10 # Passo para configurar o ambiente Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: üì¶ Instalar depend√™ncias # Instala as bibliotecas Python necess√°rias
        run: |
          python -m pip install -U pip
          python -m pip install -r requirements.txt
          python -m pip install "prefect==2.16.4"
          # Instale ferramentas de linting e teste, se ainda n√£o estiverem no requirements.txt
          python -m pip install flake8 pytest # Exemplo: Flake8 para linting, Pytest para testes
          
          # Configura PYTHONPATH para Windows (PowerShell)
          # Isso √© crucial para que o Prefect encontre os m√≥dulos dentro de 'src'
          $env:PYTHONPATH="$env:PYTHONPATH;$(Get-Location)\src"
        shell: powershell

      - name: üîé Rodar Linting (Flake8)
        # Este passo garante que seu c√≥digo siga as boas pr√°ticas e padr√µes de estilo.
        run: |
          # Altere o caminho 'src' se seus arquivos Python estiverem em outro lugar
          flake8 src
        shell: powershell
        continue-on-error: true # Permite que o workflow continue mesmo se o linting encontrar avisos/erros

      - name: üèÉ Validar e Rodar Flow Localmente (Ephemeral) # Simula a execu√ß√£o do flow
        # Este passo tenta carregar e rodar seu flow em um "Prefect Server" ef√™mero (local e tempor√°rio).
        # Isso verifica se o flow pode ser inicializado e se suas tarefas b√°sicas funcionam.
        # Ele n√£o se conecta a um servidor Prefect persistente.
        run: |
          Write-Host "Tentando rodar o flow Prefect localmente para valida√ß√£o..."
          # Prefect orion start (executa um servidor ef√™mero)
          # --ephemeral para garantir que √© tempor√°rio e n√£o interfere com configura√ß√µes existentes
          # & para rodar em background e permitir o pr√≥ximo comando
          Start-Process -FilePath "prefect" -ArgumentList "orion start --ephemeral" -NoNewWindow
          
          # D√™ um tempo para o Orion iniciar
          Start-Sleep -Seconds 10
          
          # Tenta rodar o flow. Substitua o entrypoint pelo seu flow real.
          # O comando 'prefect run' executa um flow localmente (sem implantar).
          prefect run src/flows/orchestrator_flow.py:simulacao_e_visualizacao_orchestrator
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Execu√ß√£o local do flow bem-sucedida!"
          } else {
            throw "A execu√ß√£o local do flow falhou."
          }
        shell: powershell

